<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Loan Personalised Pricing Demo</title>

    <!-- jQuery (required for Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS (after jQuery) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Table and Filter Control JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.1/dist/bootstrap-table.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/handlebars@4.7.7/dist/handlebars.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script> -->

    <!-- Bootstrap Table and Filter Control CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.1/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.css">
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css"> -->
    <link rel="stylesheet" type="text/css" href="css/pricing.css">
    
</head>
<body>
    <h1>Home Loan Personalised Pricing Demo</h1>
    <div class="tabs" id="tabs-container">
        <button class="tab-button" onclick="openTab(event, 'homeloan-calculator')">Home Loan Calculator</button>
        <button class="tab-button" onclick="openTab(event, 'pricing-variables')">Pricing Variables</button>
        <button class="tab-button" onclick="openTab(event, 'price-point')">Price Points</button>
        <button class="tab-button" onclick="openTab(event, 'customer')">Customers</button>
    </div>


    <div id="product-details"></div> <!-- Container for rendered HTML -->
    <!-- Main Product Template -->

        <div id="homeloan-calculator" class="tab-content" style="display: block;">
            <label for="submittedBy">Submitted By:</label>
            <select id="submittedBy">
            <option value="Direct">Direct</option>
            <option value="Broker">Broker</option>
            </select>
            <br>
            <label for="customer">Customer:</label>
            <select id="customer-select">
            <!-- Options will be populated dynamically -->
            </select>
            <br>
            <div id="customer-attributes">
            <!-- Customer attributes will be displayed here -->
            </div>
            <br>
            <label for="price-type">Price Type:</label>
            <select id="price-type">
            <option value="Acquisition">Acquisition</option>
            <option value="Retention">Retention</option>
            </select>
            <br>
            <!-- add property usage select box with Owner and Investor as options -->
            <label for="property-usage">Property Usage:</label>
            <select id="property-usage">
                <option value="Owner">Owner</option>
                <option value="Investor">Investor</option>
            </select>
            <br>
            <!-- add interest repayment select box with Principal & Interest and Interest Only as options -->
            <label for="interest-repayment">Interest Repayment:</label>
            <select id="interest-repayment">
                <option value="P&I">Principal & Interest</option>
                <option value="IO">Interest Only</option>
            </select>
            <br>
            <label for="total-mortgage-lending">Total Mortgage Lending:</label>
            <input type="range" id="total-mortgage-lending" min="100000" max="1000000" step="100000" value="300000">
            <span id="total-mortgage-lending-value-display">$300,000 (Average)</span>
            <br>
            <label for="loan-to-value">Loan to Value Ratio:</label>
            <input type="range" id="loan-to-value" min="0" max="100" step="1">
            <span id="loan-to-value-display">50% (Low)</span>
            <br>
            <button id="calculate-price" disabled>Calculate Personalised Price</button>
            <br>
            <div id="advertised-price">
            <!-- Calculated fields will be displayed here -->
            </div>
            <div id="personalised-price">
                <!-- Calculated fields will be displayed here -->
                </div>
            </div>

        <div id="pricing-variables" class="tab-content" style="display: none;">
            <h2>Loan Size</h2> 
                <label>
                <span><b>Small: </b></span>
                <input type="text" id="loan-size-small" value="200000" disabled="true">
                </label>
                <label>
                <span><b>Average: </b></span>
                <span id="loan-size-average">200000 to 600000</span>
                </label>
                <label>
                <span><b>Big: </b></span>
                <input type="text" id="loan-size-big" value="600000" disabled="true">
                </label>
            
            <h2>LVR Band</h2> 
                <label>
                <span><b>Low: </b></span>
                <input type="text" id="lvr-band-low" value="60" disabled="true">
                </label>
                <label>
                <span><b>Medium: </b></span>
                <span id="lvr-band-medium">60% - 80%</span>
                </label>
                <label>
                <span><b>High: </b></span>
                <input type="text" id="lvr-band-high" value="80" disabled="true">
                </label>        
        </div>

        <script id="pricing-template" type="text/x-handlebars-template">

        <div id="price-point" class="tab-content" style="display: none;">
            {{> homeloan-price-points-template}}
        </div>

        <div id="customer" class="tab-content" style="display: none;">
            {{> customer-pricing-template}}
        </div>
    
        </script>

    <script>
function openTab(evt, tabName) {
            console.log(`openTab called with tabName: ${tabName}`);
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                console.log(`Hiding tabcontent element ${i}: ${tabcontent[i].id}`);
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                console.log(`Removing active class from tablink element ${i}: ${tablinks[i].id}`);
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            console.log(`Showing tabcontent element: ${tabName}`);
            document.getElementById(tabName).style.display = "block";
            console.log(`Adding active class to tablink element: ${evt.currentTarget.id}`);
            evt.currentTarget.className += " active";
        }

        // Set default active tab
        document.addEventListener("DOMContentLoaded", async function() {
            await loadPartial('homeloan-price-points-template', 'hbs/homeloan-price-points.hbs');
            await loadPartial('customer-pricing-template', 'hbs/customer-pricing2.hbs');
            const tabsContainer = document.getElementById('tabs-container');
            if (tabsContainer) {
                document.querySelector(".tab-button").click();
            }
        });
    let productArray = []; // Global variable to store product data
    let customerArray = []; // Global variable to store customer data

      async function loadPartial(name, path) {
          return fetch(path)
            .then(response => response.text())
            .then(templateContent => {
              Handlebars.registerPartial(name, templateContent);
            })
            .catch(error => console.error(`Error loading partial ${name}: ${error}`));
      }

      async function getProducts() {
          const productJsonUrl = 'datasets/homeloan-price-points.json';
          try {
              const productResponse = await fetch(productJsonUrl);
              const productData = await productResponse.json();
              productArray = productData.products; // Assign to global variable
              return productArray;
          } catch (err) {
              console.error(`Error getting product pricing data: ${err}`);
              return { products: [] };
          }
      }
      async function getCustomers() {

          const customerJsonUrl = 'datasets/customer-pricing.json';
          try {
              const customerResponse = await fetch(customerJsonUrl);
            //   console.log('customerResponse:', customerResponse);
              const customerData = await customerResponse.json();
              customerArray = customerData.customers; // Assign to global variable
              return customerArray;
          } catch (err) {
              console.error(`Error getting customer pricing data: ${err}`);
              return { customers: [] };
          }
      }

      function renderPricingDetails(context) {
        console.log('renderPricingDetails', context);
          const templateSource = document.getElementById('pricing-template').innerHTML;
          const template = Handlebars.compile(templateSource);
          const html = template(context);
          document.getElementById('product-details').innerHTML = html;        
      }

    window.onload = async function () {

        Handlebars.registerHelper('ifEquals', function(arg1, arg2, options) {
        // If options.fn exists, it's being used as a block helper
        if (options && typeof options.fn === 'function') {
            return arg1 === arg2 ? options.fn(this) : options.inverse(this);
        }
        // If options.fn doesn't exist, it's being used as a subexpression
        return arg1 === arg2;
        });


        Handlebars.registerHelper('formatValue', function(val, format) {
            let formattedVal;

            // Ensure 'val' is a number where needed
            const isNumber = typeof val === 'number' && !isNaN(val);

            switch (format) {
                case 'AMOUNT':
                    if (isNumber) {
                        formattedVal = `$${val.toFixed(2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')}`;
                    } else if (val !== null) {
                        formattedVal = `$${val}`;
                    } else {
                        formattedVal = 'Invalid amount (datatype: ' + (typeof val) + ')';
                    }
                    break;
                case 'PERCENTAGE':
                    if (isNumber) {
                        formattedVal = (val ).toFixed(2) + '%';
                    } else if (val !== undefined && val !== null) {
                        formattedVal = val + '%';
                    } else {
                        formattedVal = 'Invalid percentage';
                    }
                    break;
                default:
                    formattedVal = val !== undefined && val !== null ? val : 'N/A';
            }
            return formattedVal;
        });

        let tableIndex = 0; // Global counter for table IDs
        Handlebars.registerHelper('uniqueTableId', function() {
        return `table-${tableIndex++}`;
        });

        // Register a Handlebars helper to execute JavaScript code after rendering
        Handlebars.registerHelper('initializeTable', function() {
        // After the DOM is updated, initialize each table separately
        setTimeout(() => {
            $('[id^=table-]').each(function() {
            const tableId = $(this).attr('id');
            $('#' + tableId).bootstrapTable(); // Initialize the Bootstrap Table
            });
        }, 100);
        });

        await loadPartial('homeloan-price-points-template', 'hbs/homeloan-price-points.hbs');
        await loadPartial('customer-pricing-template', 'hbs/customer-pricing2.hbs');

        const productData = await getProducts();

        let customerData = await getCustomers();

        const customerSelect = document.getElementById('customer-select');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Select a customer';
        option.disabled = true;
        option.selected = true;
        customerSelect.appendChild(option); // Append the option to the select element

        customerArray.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.customerId; // Use customerId for value
            option.textContent = customer.name; // Use customer name for textContent
            customerSelect.appendChild(option); // Append the option to the select element
        });


        // Update customer attributes on selection change
        customerSelect.addEventListener('change', function() {
            const selectedCustomerId = this.value;
            const selectedCustomer = customerArray.find(c => c.customerId === selectedCustomerId);
            const customerAttributesDiv = document.getElementById('customer-attributes');
            customerAttributesDiv.innerHTML = `
            ${selectedCustomer.cohorts.map(cohort => `<button class="button green-button" disabled="true">${cohort}</button>`).join(' ')}`;
            // Enable the calculate price button if a customer is selected
            document.getElementById('calculate-price').disabled = !selectedCustomerId;
        });

        // Update loan to value display
        const smallLoan = parseFloat(document.getElementById('loan-size-small').value);
        const bigLoan = parseFloat(document.getElementById('loan-size-big').value);
        const totalMortgageLendingSlider = document.getElementById('total-mortgage-lending');
        const totalMortgageLendingDisplay = document.getElementById('total-mortgage-lending-value-display');
        totalMortgageLendingSlider.addEventListener('input', function() {
            if (this.value < smallLoan  ) {
                totalMortgageLendingDisplay.textContent = `$${Number(this.value).toLocaleString()} (Small)`;
            } else if (this.value >= bigLoan) {
                totalMortgageLendingDisplay.textContent = `$${Number(this.value).toLocaleString()} (Big)`;
            } else {
                totalMortgageLendingDisplay.textContent = `$${Number(this.value).toLocaleString()} (Average)`;
            }
        });

        // Update loan to value display
        const lowLVR = parseFloat(document.getElementById('lvr-band-low').value);
        const highLVR = parseFloat(document.getElementById('lvr-band-high').value);
        const loanToValueSlider = document.getElementById('loan-to-value');
        const loanToValueDisplay = document.getElementById('loan-to-value-display');
        loanToValueSlider.addEventListener('input', function() {
            if (this.value < lowLVR) {
                loanToValueDisplay.textContent = `${this.value}% (Low)`;
            } else if (this.value >= highLVR) {
                loanToValueDisplay.textContent = `${this.value}% (High)`;
            } else {
                loanToValueDisplay.textContent = `${this.value}% (Medium)`;
            }
        });

        // Calculate Advertised price
        document.getElementById('calculate-price').addEventListener('click', function() {
            const selectedCustomerId = customerSelect.value;
            const selectedCustomer = customerArray.find(c => c.customerId === selectedCustomerId);
            const priceType = document.getElementById('price-type').value;
            const propertyUsage = document.getElementById('property-usage').value;
            const interestRepayment = document.getElementById('interest-repayment').value;
            const totalMortgageLending = Number(totalMortgageLendingSlider.value);
            const loanToValue = parseFloat(loanToValueSlider.value);

            const context = {
            customerId: selectedCustomerId,
            productId: 'HLVAR01', // default product ID
            loanAmt: totalMortgageLending,
            lvr: loanToValue,
            purpose: propertyUsage, 
            repayment: interestRepayment, 
            priceTier: 'Advertised' // default price tier
            };

            const pricing = resolvePricing(context);
            const advertisedPriceFieldsDiv = document.getElementById('advertised-price');
            advertisedPriceFieldsDiv.innerHTML = `<h2>Advertised Price</h2>${pricing.map(p => `<b>${p.name}:</b> ${p.value}</br>`).join('')}`;

            //loop thru each customer cohort and display the pricing details
            let personalisedPriceFieldsDivHtml = '';
            selectedCustomer.cohorts.forEach(cohort => {
                const context = {
                customerId: selectedCustomerId,
                productId: 'HLVAR01', // default product ID
                loanAmt: totalMortgageLendingSlider.value,
                lvr: loanToValueSlider.value,
                purpose: propertyUsage, 
                repayment: interestRepayment, 
                priceTier: cohort // cohort vsalue
                };

                const pricing = resolvePricing(context);
                personalisedPriceFieldsDivHtml += `<h2>Personalised Price - ${cohort}</h2>${pricing.map(p => `<b>${p.name}:</b> ${p.value}</br>`).join('')}`;
                });

                // if submittedby===broker, then resolvePricing using Broker price tier
                const submittedBy = document.getElementById('submittedBy').value;
                if (submittedBy === 'Broker') {
                const context = {
                customerId: selectedCustomerId,
                productId: 'HLVAR01', // default product ID
                loanAmt: totalMortgageLendingSlider.value,
                lvr: loanToValueSlider.value,
                purpose: propertyUsage, 
                repayment: interestRepayment, 
                priceTier: "Broker" // Broker price tier
                };

                const pricing = resolvePricing(context);
                personalisedPriceFieldsDivHtml += `<h2>Personalised Price - Broker</h2>${pricing.map(p => `<b>${p.name}:</b> ${p.value}</br>`).join('')}`;
                };

            const personalisedPriceFieldsDiv = document.getElementById('personalised-price');
            personalisedPriceFieldsDiv.innerHTML = personalisedPriceFieldsDivHtml;

        }); 
    }
 
    // function updateAverageLoanSize() {
    //     let smallValue = parseFloat(document.getElementById('loan-size-small').value) || 0;
    //     let bigValue = parseFloat(document.getElementById('loan-size-big').value) || 0;
    //     if (bigValue <= smallValue) {
    //         bigValue = smallValue + 1; // Ensure bigValue is greater than smallValue
    //         document.getElementById('loan-size-big').value = bigValue; // Update the input field
    //     }
    //     const mediumValueElement = document.getElementById('loan-size-average');
    //     mediumValueElement.textContent = `${smallValue} to ${bigValue}`;
    // }
    // function updateMediumLVRBand() {
    //     let smallValue = parseFloat(document.getElementById('lvr-band-low').value) || 0;
    //     let bigValue = parseFloat(document.getElementById('lvr-band-high').value) || 0;
    //     if (bigValue <= smallValue) {
    //         bigValue = smallValue + 1; // Ensure bigValue is greater than smallValue
    //         document.getElementById('lvr-band-high').value = bigValue; // Update the input field
    //     }
    //     const mediumValueElement = document.getElementById('lvr-band-medium');
    //     mediumValueElement.textContent = `${smallValue}% to ${bigValue}%`;
    // }

    function resolvePricing(context) {

    // Filter all pricingItems in Product based on productCode
    let pricing = [];
    const pricingItems = productArray[0].priceTier
        .find(tier => tier.priceTierName === context.priceTier)
        .pricingItems;
 
    // Loop through the pricingItems and call resolvePricingItem for pricingItem.. the result is then added to the pricing array
    pricingItems.forEach(pricingItem => {
        const value = resolvePricingItem(pricingItem, context);
        if (value !== null) pricing.push({ name: pricingItem.pricingItem, valueType: pricingItem.valueType, value: value.toString() });
    });

    const rateElement = pricing.find(element => element.name === 'Rate');
    const rate = rateElement ? parseFloat(rateElement.value) : 0;
    const rateDiscountElement = pricing.find(element => element.name === 'Rate Discount');    
    const rateDiscount = rateDiscountElement ? parseFloat(rateDiscountElement.value) : 0;
    const lateFeeElement = pricing.find(element => element.name === 'Late Fee');
    const lateFee = lateFeeElement ? parseFloat(lateFeeElement.value) : 0;

    // const netRate = (rate + rateDiscount).toFixed(2);
    // const comparisonRate = resolveComparisonRate(parseFloat(context.loanAmt), parseFloat(netRate), lateFee*12*25, 25);
    // pricing.push({ name: 'Net Rate', valueType: 'PERCENTAGE', value: netRate}); 
    // pricing.push({ name: 'Compare Rate', valueType: 'PERCENTAGE', value: comparisonRate.toString()});
    
    return pricing;
    }

    function resolvePricingItem(pricingItem, context) {

        if (pricingItem.rule) {
            // console.log(`Rule "${pricingItem.rule}" evaluated for account ${accountId}`);
            if (resolveRule(pricingItem.rule, context)) {
                // console.log(`Rule "${pricingItem.rule}" passed for account ${accountId}`);
                return pricingItem.value;
            } else {
                // console.log(`Rule "${pricingItem.rule}" failed for account ${accountId}`);
                return null;
            }
        } else {
            // console.log(`No rule for account ${accountId} and product ${pricingItem.productId}`);
            return pricingItem.value;
        }
    }

//     function resolveComparisonRate(principal, interestRate, fees, termYears) {

//     // console.log(`resolveComparisonRate called with principal: ${principal}, interestRate: ${interestRate}, fees: ${fees}, termYears: ${termYears}`);
        
//     // Convert annual interest rate to monthly
//     let monthlyInterestRate = interestRate / 12 / 100;
//     let numberOfPayments = termYears * 12;

//     // Monthly payment calculation (principal and interest)
//     let monthlyPayment = (principal * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -numberOfPayments));
    
//     // Total fees spread over the life of the loan
//     let totalFees = fees / numberOfPayments;
    
//     // Comparison rate calculation
//     let monthlyComparisonRate = ((monthlyPayment + totalFees) / principal) * 100;
//     let comparisonRate = monthlyComparisonRate * 12; // Convert to annual rate
//     // console.log(`The comparison rate is ${comparisonRate}.%`);
    
//     return comparisonRate.toFixed(2);
// }
    
    function resolveRule(rule, context) {
        // console.log(`resolveRule(${rule},${account})`);
        // Define rule mapping
        const ruleMap = {
            "is Owner & PI": (context) => context.purpose === "Owner" && context.repayment === "P&I",
            "is Owner & IO": (context) => context.purpose === "Owner" && context.repayment === "IO",
            "is Investor & PI": (context) => context.purpose === "Investor" && context.repayment === "P&I",
            "is Investor & IO": (context) => context.purpose === "Investor" && context.repayment === "IO",
            "is Small Loan & Low LVR": (context) => context.loanAmt < parseFloat(document.getElementById('loan-size-small').value) && context.lvr < parseFloat(document.getElementById('lvr-band-low').value),
            "is Small Loan & Medium LVR": (context) => context.loanAmt < parseFloat(document.getElementById('loan-size-small').value) && context.lvr >= parseFloat(document.getElementById('lvr-band-low').value) && context.lvr < parseFloat(document.getElementById('lvr-band-high').value),
            "is Small Loan & High LVR": (context) => context.loanAmt < parseFloat(document.getElementById('loan-size-small').value) && context.lvr >= parseFloat(document.getElementById('lvr-band-high').value),
            "is Average Loan & Low LVR": (context) => context.loanAmt >= parseFloat(document.getElementById('loan-size-small').value) && context.loanAmt < parseFloat(document.getElementById('loan-size-big').value) && context.lvr < parseFloat(document.getElementById('lvr-band-low').value),
            "is Average Loan & Medium LVR": (context) => context.loanAmt >= parseFloat(document.getElementById('loan-size-small').value) && context.loanAmt < parseFloat(document.getElementById('loan-size-big').value) && context.lvr >= parseFloat(document.getElementById('lvr-band-low').value) && context.lvr < parseFloat(document.getElementById('lvr-band-high').value),
            "is Average Loan & High LVR": (context) => context.loanAmt >= parseFloat(document.getElementById('loan-size-small').value) && context.loanAmt < parseFloat(document.getElementById('loan-size-big').value) && context.lvr >= parseFloat(document.getElementById('lvr-band-high').value),
            "is Big Loan & Low LVR": (context) => context.loanAmt >= parseFloat(document.getElementById('loan-size-big').value) && context.lvr < parseFloat(document.getElementById('lvr-band-low').value),
            "is Big Loan & Medium LVR": (context) => context.loanAmt >= parseFloat(document.getElementById('loan-size-big').value) && context.lvr >= parseFloat(document.getElementById('lvr-band-low').value) && context.lvr < parseFloat(document.getElementById('lvr-band-high').value),
            "is Big Loan & High LVR": (context) => context.loanAmt >= parseFloat(document.getElementById('loan-size-big').value) && context.lvr >= parseFloat(document.getElementById('lvr-band-high').value),
            "if Cashback conditions met": (context) => context.loanAmt >=250000 && context.lvr >= parseFloat(document.getElementById('lvr-band-high').value),
            "if Cashback conditions not met": (context) => context.loanAmt < 250000 || context.lvr < parseFloat(document.getElementById('lvr-band-high').value)
        };

        // Check if the rule exists in the map and apply it
        if (rule in ruleMap) {
            return ruleMap[rule](context);
        }
        return false; // Return false if the rule is not found
    }

    </script>
</body>
</html>

